<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Send â€” CrowMail</title>
  <link rel="stylesheet" href="styles.css">
  <script src="main.js" defer></script>
</head>
<body>

<nav>
  <div>
    <a href="/home.html">Home</a>
    <a href="/send.html">Send</a>
    <a href="/view.html">Inbox</a>
    <a href="/feedback.html">Feedback</a>
    <a href="/ai.html">AI Bot</a>
  </div>
  <div>
    <a href="#" onclick="logout()">Logout</a>
  </div>
</nav>

<div class="card">
  <h2>Send a Crow</h2>
  <div id="auth-box"></div>

  <div id="send-box" style="display:none;">
    <label>To (username)</label><br>
    <input id="to" placeholder="recipient username"><br><br>
    <label>Subject</label><br>
    <input id="subject" placeholder="subject"><br><br>
    <label>Message</label><br>
    <textarea id="body" rows="6"></textarea><br><br>
    <button id="send-btn">Send</button>
    <div id="send-result" style="margin-top:10px"></div>
  </div>
</div>

<script>
  // on page load: show login/register or send form
  const authBox = document.getElementById("auth-box");
  const sendBox = document.getElementById("send-box");
  function showAuth() {
    const u = getUser();
    if (u) {
      authBox.innerHTML = `<strong>Logged in as ${u.username}</strong> <button onclick="logout()">Logout</button>`;
      sendBox.style.display = "block";
    } else {
      sendBox.style.display = "none";
      authBox.innerHTML = `
        <div>
          <h3>Login</h3>
          <input id="li-un" placeholder="username"><br>
          <input id="li-pw" type="password" placeholder="password"><br>
          <button id="li-btn">Login</button>
          <p>or Register</p>
          <input id="re-un" placeholder="username"><br>
          <input id="re-pw" type="password" placeholder="password"><br>
          <button id="re-btn">Register</button>
          <div id="auth-msg"></div>
        </div>
      `;
      document.getElementById("li-btn").onclick = async () => {
        const u = document.getElementById("li-un").value, p = document.getElementById("li-pw").value;
        const r = await login(u,p);
        document.getElementById("auth-msg").innerText = r.ok ? "Logged in!" : (r.error||"Login failed");
        if (r.ok) { showAuth(); }
      };
      document.getElementById("re-btn").onclick = async () => {
        const u = document.getElementById("re-un").value, p = document.getElementById("re-pw").value;
        const r = await register(u,p);
        document.getElementById("auth-msg").innerText = r.ok ? "Account created!" : (r.error||"Register failed");
        if (r.ok) { showAuth(); }
      };
    }
  }
  showAuth();

  document.getElementById("send-btn").onclick = async () => {
    const to = document.getElementById("to").value;
    const subject = document.getElementById("subject").value;
    const body = document.getElementById("body").value;
    const res = await sendMessage(to, subject, body);
    document.getElementById("send-result").innerText = res.ok ? "Sent!" : (res.error || "Failed");
  };
</script>

</body>
</html>
