<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Inbox — CrowMail</title>
  <link rel="stylesheet" href="styles.css">
  <script src="main.js" defer></script>
</head>
<body>
<nav>
  <div>
    <a href="/home.html">Home</a>
    <a href="/send.html">Send</a>
    <a href="/view.html">Inbox</a>
    <a href="/feedback.html">Feedback</a>
    <a href="/ai.html">AI Bot</a>
  </div>
  <div>
    <a href="#" onclick="logout()">Logout</a>
  </div>
</nav>

<div class="card">
  <h2>Inbox</h2>
  <div id="inbox-area">
    <div id="login-area"></div>
  </div>

  <div id="message-area" style="display:none;margin-top:20px;">
    <button onclick="document.getElementById('message-area').style.display='none'">Back</button>
    <h3 id="m-sub"></h3>
    <p><strong>From:</strong> <span id="m-from"></span></p>
    <p id="m-body"></p>
    <div id="m-reply"></div>
  </div>
</div>

<script>
  async function loadInbox() {
    const u = getUser();
    const area = document.getElementById("inbox-area");
    if (!u) {
      area.innerHTML = `<p>Please log in to see your inbox.</p>
        <input id="li-un" placeholder="username"><br>
        <input id="li-pw" type="password" placeholder="password"><br>
        <button id="li-btn">Login</button>`;
      document.getElementById("li-btn").onclick = async () => {
        const r = await login(document.getElementById("li-un").value, document.getElementById("li-pw").value);
        if (r.ok) loadInbox();
        else alert(r.error||"err");
      };
      return;
    }
    area.innerHTML = `<p>Loading...</p>`;
    const res = await fetchInbox();
    if (!res.ok) { area.innerText = res.error||"Failed"; return; }
    if (!res.messages || res.messages.length===0) area.innerHTML = "<p>No messages yet.</p>";
    else {
      area.innerHTML = "<ul id='msglist'></ul>";
      res.messages.forEach(m => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${m.subject||"(no subject)"}</strong> — from ${m.from} <button data-id="${m.id}">Open</button>`;
        document.getElementById("msglist").appendChild(li);
      });
      document.querySelectorAll("button[data-id]").forEach(b => b.onclick = async (e) => {
        const id = e.target.getAttribute("data-id");
        const r = await fetchMessage(id);
        if (r.ok) {
          document.getElementById("m-sub").innerText = r.message.subject || "(no subject)";
          document.getElementById("m-from").innerText = r.message.from;
          document.getElementById("m-body").innerText = r.message.body;
          document.getElementById("m-reply").innerHTML = `<textarea id="replytxt" rows="3"></textarea><br><button id="replybtn">Reply</button>`;
          document.getElementById("replybtn").onclick = async () => {
            const body = document.getElementById("replytxt").value;
            // reply by sending a new message back
            const send = await sendMessage(r.message.from, "Re: "+(r.message.subject||""), body);
            alert(send.ok ? "Replied!" : (send.error||"Failed"));
          };
          document.getElementById("message-area").style.display = "block";
        } else alert(r.error||"Failed to open");
      });
    }
  }
  loadInbox();
</script>

</body>
</html>
